# i18n Design Document

## Overview

This document outlines the design for adding internationalization (i18n) support to gcal-commander using i18next. The implementation will support multiple languages with English as the default and Japanese as the first additional language.

## Requirements

### Functional Requirements
- Interactive language selection during `init` command
- Persistent language preference storage in configuration
- All user-facing text translated (commands, messages, errors)
- Fallback to English for missing translations
- Support for pluralization and interpolation

### Non-Functional Requirements
- Minimal performance impact on command execution
- Clean separation of concerns
- Backward compatibility with existing configurations
- Easy addition of new languages

## Architecture

### Core Components

#### 1. I18nService
```typescript
interface II18nService {
  init(): Promise<void>;
  t(key: string, options?: any): string;
  changeLanguage(language: string): Promise<void>;
  getAvailableLanguages(): string[];
}
```

#### 2. Language Detection Strategy
1. **Configuration file**: `~/.gcal-commander/config.json` `language` field
2. **Environment variable**: `GCAL_COMMANDER_LANG`
3. **Default fallback**: English (`en`)

Note: System locale detection is intentionally excluded to ensure explicit user choice and avoid unexpected behavior across different environments.

#### 3. Translation File Structure
```
src/
└── locales/
    ├── en/
    │   ├── common.json
    │   ├── commands.json
    │   ├── errors.json
    │   └── validation.json
    └── ja/
        ├── common.json
        ├── commands.json
        ├── errors.json
        └── validation.json
```

### Integration Points

#### 1. BaseCommand Extension
```typescript
abstract class BaseCommand extends Command {
  protected i18nService!: II18nService;
  
  async init(): Promise<void> {
    // Initialize i18n service
    this.i18nService = this.getContainer().resolve<II18nService>(TOKENS.I18nService);
    await this.i18nService.init();
  }
  
  protected t(key: string, options?: any): string {
    return this.i18nService.t(key, options);
  }
}
```

#### 2. ConfigService Extension
```typescript
interface Config {
  language?: string;
  // existing fields...
}

// Add to VALID_KEYS
private static readonly VALID_KEYS = [
  'language',
  'defaultCalendar',
  // existing keys...
] as const;
```

#### 3. PromptService Extension
```typescript
interface IPromptService {
  confirm(message: string, defaultValue?: boolean): Promise<boolean>;
  select(message: string, choices: SelectChoice[]): Promise<string>;
}

interface SelectChoice {
  name: string;
  value: string;
}
```

## Implementation Plan

### Phase 1: TDD Foundation & Core Infrastructure
1. **Add I18nService to mock infrastructure** (TDD First - Enable testing before implementation)
   - Add II18nService interface to `src/interfaces/services.ts`
   - Create AuthServiceMockFactory for I18nService mocking
   - Extend TestContainerFactory to include mockI18nService
   - Update DI tokens and container registration
2. Add i18next dependencies
3. Create I18nService implementation
4. Extend BaseCommand with i18n support
5. Add language configuration support
6. Create initial translation files (en/ja)

### Phase 2: Init Command Enhancement
1. Extend PromptService with select functionality
2. Add language selection to init command
3. Implement language preference persistence
4. Add confirmation messages in selected language

### Phase 3: Command Translation
1. Translate all command descriptions and examples
2. Translate status messages and errors
3. Translate validation messages
4. Add pluralization support for count-based messages

### Phase 4: Error Handling & Edge Cases
1. Handle missing translation keys gracefully
2. Implement language switching for existing users
3. Add validation for language configuration
4. Handle locale-specific formatting (dates, numbers)

## Translation Key Naming Convention

### Hierarchical Structure
```json
{
  "commands": {
    "init": {
      "description": "Verify Google Calendar authentication setup",
      "examples": {
        "basic": "gcal init"
      },
      "messages": {
        "confirm": "Do you want to verify authentication?",
        "success": "Authentication successful!",
        "cancelled": "Operation cancelled."
      }
    }
  },
  "errors": {
    "auth": {
      "failed": "Authentication failed: {{message}}",
      "network": "Network error occurred"
    }
  },
  "common": {
    "loading": "Loading...",
    "yes": "Yes",
    "no": "No"
  }
}
```

### Key Naming Rules
- Use snake_case for keys
- Group by feature/command
- Separate common, commands, errors, validation
- Use interpolation for dynamic content: `{{variable}}`
- Use pluralization for count-dependent text

## Language Selection UX

### Init Command Flow
```
$ gcal init
? Select your preferred language:
  ❯ English
    日本語
    
? 認証を確認しますか？ (Y/n)
```

### Language Switching
```
$ gcal config set language ja
Language changed to Japanese. Changes will take effect immediately.

$ gcal config set language en  
Language changed to English. Changes will take effect immediately.
```

## File Organization

### New Files
- `src/services/i18n.ts` - I18nService implementation
- `src/interfaces/services.ts` - Add II18nService interface
- `src/locales/en/*.json` - English translations
- `src/locales/ja/*.json` - Japanese translations
- `src/di/tokens.ts` - Add I18nService token

### Modified Files
- `src/base-command.ts` - Add i18n support
- `src/services/config.ts` - Add language configuration
- `src/services/prompt.ts` - Add select functionality
- `src/commands/init.ts` - Add language selection
- `src/di/container.ts` - Register I18nService
- `package.json` - Add i18next dependencies

## Testing Strategy

### TDD Approach
- **Mock-first development**: All I18nService functionality must be mockable before implementation
- **Red-Green-Refactor**: Write failing tests first, implement minimal code to pass, then refactor
- **Integration testing**: Test real i18n behavior with actual translation files

### Unit Tests
- I18nService functionality
- Translation key resolution
- Language switching behavior
- Fallback mechanisms

### Integration Tests
- Init command language selection
- Configuration persistence
- Command output in different languages
- Error message translation

### Test Infrastructure
- MockI18nService with Sinon stubs for all II18nService methods
- Test container factory extensions with mockI18nService
- Mock translation files for testing
- Language-specific test scenarios

## Dependencies

### Production Dependencies
```json
{
  "i18next": "^23.7.0",
  "i18next-fs-backend": "^2.3.0"
}
```

### Development Dependencies
```json
{
  "@types/i18next": "^13.0.0"
}
```

## Backward Compatibility

- Existing configurations without `language` field will default to English
- All existing command behavior remains unchanged
- New language configuration is optional
- Graceful degradation for missing translations

## Performance Considerations

- Lazy loading of translation files
- Caching of loaded translations
- Minimal overhead for translation key resolution
- Asynchronous initialization to avoid blocking command startup

## Implementation Status (Updated)

### ✅ Completed Features
- **Core I18nService**: Fully implemented with i18next integration
- **Translation Files**: English and Japanese translations for `init` and `events/list` commands
- **DI Integration**: Complete dependency injection setup with TestContainerFactory support
- **BaseCommand Integration**: i18n support built into base command class
- **Commands Implemented**:
  - `init`: Full i18n support with language selection
  - `events/list`: Complete English/Japanese translations for all messages
- **Test Infrastructure**: Comprehensive test patterns for both legacy and modern approaches

### ⏳ Remaining Commands to Implement
- `events/show`: Status messages, error handling
- `events/create`: User prompts, confirmation messages, error handling
- `calendars/list`: Status messages, table headers
- `config`: Configuration messages, validation errors

### 🧪 Testing Patterns Established

#### Modern Pattern (Recommended): TestContainerFactory
```typescript
describe('command i18n integration', () => {
  describe('English translation (default)', () => {
    beforeEach(() => {
      const { mocks } = TestContainerFactory.create();
      const realI18nService = new I18nService();
      TestContainerFactory.registerService(TOKENS.I18nService, realI18nService);
      mocks.calendarService.listEvents.resolves([]);
    });

    it('should display messages in English', async () => {
      const { stderr, stdout } = await runCommand('command');
      expect(stderr).to.include('English message...');
    });
  });

  describe('Japanese translation', () => {
    beforeEach(async () => {
      const { mocks } = TestContainerFactory.create();
      const realI18nService = new I18nService();
      await realI18nService.init();
      await realI18nService.changeLanguage('ja');
      TestContainerFactory.registerService(TOKENS.I18nService, realI18nService);
      mocks.calendarService.listEvents.resolves([]);
    });

    it('should display messages in Japanese', async () => {
      const { stderr, stdout } = await runCommand('command');
      expect(stderr).to.include('日本語メッセージ...');
    });
  });
});
```

#### Legacy Pattern (Backward Compatibility): setupTestContainer
- Uses real I18nService for backward compatibility
- Automatically loads English translations by default
- Maintains existing test behavior without modification

#### Test Coverage Requirements
Each i18n-enabled command should test:
1. **Status Messages**: Authentication, fetching, processing messages
2. **Result Messages**: Success confirmations, data output headers
3. **Error Messages**: Failure scenarios, validation errors
4. **Empty State Messages**: No data found scenarios
5. **Interactive Messages**: Prompts, confirmations (for applicable commands)
6. **Both Languages**: English (default) and Japanese translations

### 🔧 Implementation Process for Remaining Commands

#### TDD Cycle for Each Command
1. **Red**: Create failing i18n test using TestContainerFactory pattern
2. **Green**: 
   - Add `await this.initI18nService()` to command
   - Replace hardcoded strings with `this.t('key.path')`
   - Use proper translation keys (without 'commands.' prefix due to defaultNS)
3. **Refactor**: 
   - Add translation keys to `en/commands.json` and `ja/commands.json`
   - Verify tests pass for both languages
   - Ensure backward compatibility with existing tests

#### Translation Key Naming Convention
- **Namespace**: Use 'commands' as default namespace
- **Structure**: `{command}.{subcommand}.{messageType}`
- **Examples**:
  - `events.show.authenticating`
  - `events.create.confirmCreation`
  - `calendars.list.noCalendarsFound`
  - `config.set.valueUpdated`

## Future Enhancements

- Dynamic locale-based date/time formatting
- Support for right-to-left languages
- Enhanced language management commands
- Translation validation tools
- Community translation contributions